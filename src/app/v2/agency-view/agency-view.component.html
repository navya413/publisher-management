<div class="head">
  <app-breadcrumb [segments]="breadcrumbSegments"></app-breadcrumb>
</div>

<div class="pa-2" *ngIf="setupView">
  <m-table
    [value]="publishers"
    (onFilter)="onFilter($event)"
    (onReload)="onReload()"
    [selectable]="true"
    (onPage)="onPageChange($event)"
    [selection] = "selectedPublishers"
    (selectionChange)="onRowSelectionChange($event)"
    [selectionMode]="'single'"
  >
    <m-header>
      <ng-template let-header>
        <div class="card-header">
          <button mat-raised-button color="primary" (click)="openAssignPublisherModal($event)" class="btn-margin">Assign Publisher</button>

          <!-- Manage section  -->
          <button [disabled]="!selectedPublishers.length" mat-raised-button (click)="editMenu.open()" class="btn-margin">
            <mat-select [disabled]="!selectedPublishers.length" #editMenu placeholder="Manage" class="agencyList">
              <mat-option (click)="editPublisher(option)"
                  *ngFor="let option of editOptions">{{option.name}}</mat-option>
            </mat-select>
          </button>

          <!-- Search box -->
          <div class="box-search btn-margin">
            <div class="box-search-icon">
              <button mat-icon-button (click)="getAllPublishers()">
                <mat-icon class="mat-24" aria-label="Search icon">search</mat-icon>
              </button>
            </div>
            <div class="box-search-input-wrapper">
              <input type="text" [(ngModel)]="filters.query" placeholder="Search..." (keyup.enter)="getAllPublishers()" />
            </div>
          </div>

          <!-- Status filter -->
          <button mat-raised-button (click)="statusMenu.open()" class="btn-margin">
            <mat-select #statusMenu placeholder="Status" [(ngModel)]="filters.status" (change)="getAllPublishers()" class="agencyList">
              <mat-option *ngFor="let option of statusOptions" [value]="option.value">{{ option.name }}</mat-option>
            </mat-select>
          </button>

          <!-- Models filter -->
          <button mat-raised-button (click)="modelMenu.open()" class="btn-margin">
            <mat-select #modelMenu placeholder="Model" [(ngModel)]="filters.model" (change)="getAllPublishers()" class="agencyList">
              <mat-option *ngFor="let option of modelsOptions" [value]="option.value">{{ option.name }}</mat-option>
            </mat-select>
          </button>

          <!-- View Settings filter -->
          <button mat-raised-button (click)="viewMenu.open()" class="btn-margin">
            <mat-select #viewMenu placeholder="View" [(ngModel)]="selectedView" class="agencyList">
              <mat-option *ngFor="let option of viewOptions" [value]="option" (click)="changeView()">{{ option }}</mat-option>
            </mat-select>
          </button>
        </div>
      </ng-template>
    </m-header>

    <m-column field="status" header="Active">
      <ng-template let-col let-row="row" mTemplate="body">
        <i class="material-icons status-icon active" *ngIf="row.status === 'A'">check_circle</i>
        <i class="material-icons status-icon paused" *ngIf="row.status !== 'A'">pause_circle_filled</i>
      </ng-template>
    </m-column>

    <m-column field="name" header="Publisher Name"></m-column>

    <m-column field="activeClientsCount"
              [sortable]="true">
      <ng-template mTemplate="header">
        <span>Active</span>
        <br>
        <span class="sub-header">(Clients)</span>
      </ng-template>

      <ng-template let-col
                   let-row="row"
                   mTemplate="body">
        {{row['activeClientsCount']}}
      </ng-template>
    </m-column>

    <m-column field="feedType" header="Feed Type">
        <ng-template let-col let-row="row" mTemplate="body">
          {{row.feedDelivery.feedType}}
        </ng-template>
    </m-column>
    <m-column field="publisherModel" header="Publisher Model"></m-column>
    <m-column field="currency" header="Currency"></m-column>
    <m-column field="minBid" header="Min Bid"></m-column>

    <m-column field="vpAccess" header="VP Access">
      <ng-template let-col let-row="row" mTemplate="body">
        <span [class.cursor]="row.vpAccess && row.vpAccess.length > 0" (click)="viewContactDetails(row.vpAccess)">{{getContactsCount(row.vpAccess,'Email')}}</span>
      </ng-template>
    </m-column>


    <m-column field="notificationMails" header="Notifications">
      <ng-template let-col let-row="row" mTemplate="body">
        <span [class.cursor]="row.notificationMails && row.notificationMails.length > 0" (click)="viewContactDetails(row.notificationMails)">{{getContactsCount(row.notificationMails,'Contact')}}</span>
      </ng-template>
    </m-column>

    <m-column field="reconciliation" header="Reconciliation">
      <ng-template let-col let-row="row" mTemplate="body">
        <i class="material-icons status-icon active" *ngIf="row.reconciliation">check_circle</i>
        <i class="material-icons status-icon paused" *ngIf="!row.reconciliation">check_circle</i>
      </ng-template>
    </m-column>


    <m-column field="activeClientsCount"
              [sortable]="true">
      <ng-template mTemplate="header">
        <span>Avg.Freq</span>
        <br>
        <span class="sub-header">(24 hrs)</span>
      </ng-template>

      <ng-template let-col
                   let-row="row"
                   mTemplate="body">
        {{row.jobRunStats?.day?.frequency}}
      </ng-template>
    </m-column>


    <m-column field="activeClientsCount"
          [sortable]="true">
      <ng-template mTemplate="header">
      <span>Avg.Freq</span>
      <br>
      <span class="sub-header">(Last 7 days)</span>
      </ng-template>

      <ng-template let-col
              let-row="row"
              mTemplate="body">
        {{row.jobRunStats?.week?.frequency}}
      </ng-template>
    </m-column>

    <m-column field="activeClientsCount"
          [sortable]="true">
      <ng-template mTemplate="header">
      <span>Last Access</span>
      <br>
      <span class="sub-header">(Feed)</span>
      </ng-template>

      <ng-template let-col
              let-row="row"
              mTemplate="body">
          {{row.jobRunStats?.lastSuccessTimeMillis | date:"MM/dd/yyyy hh:mm:ss"}}
      </ng-template>
    </m-column>


    <m-footer [paginator]="true"
    [pageSize]="filters.limit"
    [pageIndex]="filters.page - 1"
    [pageSizeOptions]="[10,20,50]"
    [length]="totalResp.totalRecords"></m-footer>

    <ng-template mTemplate="emptyTable">
      <div *ngIf="loading" class="table-loading">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        <div>Loading...</div>
      </div>

      <div *ngIf="!loading">
        <div class="alert alert-primary ma-4">No records found.</div>
      </div>
      
    </ng-template>
  </m-table>
</div>

<div *ngIf="!setupView">
  <app-publisher-stats></app-publisher-stats>
</div>
